//CONSULTAS DE USO REAL

//Obtener la calificación promedio y el total de comentarios por cliente

db.comentarios.aggregate([
    {
        $group: {
            _id: "$idClienteSQL", //Agrupar por el idClienteSQL
            calificacionPromedio: { $avg: "$calificacion" }, //Promedio de calificaciones
            totalComentarios: { $sum: 1 } //Contar el numero de comentarios
        }
    },
    { $sort: { calificacionPromedio: -1 } } //Ordenar de mayor a menor
]);


//Contar tickets por estado y empleado asignado

db.tickets.aggregate([
    { $match: { idempleadoAsignadoSQL: { $exists: true, $ne: null } } }, //Filtrar solo los tickets que tienen un empleado asignado
    {
        //Agrupar por el ID del empleado asignado y el estado del ticket
        $group: {
            _id: {
                idEmpleado: "$idempleadoAsignadoSQL",
                estadoTicket: "$estado"
            },
            //Contar el número de tickets para ese grupo
            conteoTickets: { $sum: 1 }
        }
    },
    { $project: { _id: 0, idEmpleadoSQL: "$_id.idEmpleado", estado: "$_id.estadoTicket", cantidad: "$conteoTickets" } }, //Proyectar para mostrar los campos de forma más clara
    { $sort: { idEmpleadoSQL: 1, cantidad: -1 } } //Ordenar por el ID del empleado para mejor lectura
]);


//Unir (Lookup) Comentarios con Encuestas para Analizar la Satisfacción General

db.comentarios.aggregate([
    { $match: { calificacion: { $lte: 2 } } }, //Filtrar comentarios con calificación baja
    {
        //Unir con la colección 'encuestas'
        $lookup: {
            from: "encuestas",
            localField: "idClienteSQL", //Campo en 'comentarios'
            foreignField: "idClienteSQL", //Campo coincidente en 'encuestas'
            as: "encuestasCliente"
        }
    },
    { $unwind: "$encuestasCliente" }, //Desestructurar la matriz de encuestas (si solo se espera calificación = 1)
    { $match: { "encuestasCliente.recomendaria": false } }, //Filtrar solo las encuestas donde el cliente no recomendaría
    {
        //Proyectar para mostrar solo los campos relevantes de ambos documentos
        $project: {
            _id: 0,
            idPedidoComentario: "$idPedidoSQL",
            idCliente: "$idClienteSQL",
            calificacionComentario: "$calificacion",
            comentario: "$comentario",
            fechaEncuesta: "$encuestasCliente.fecha",
            recomiendaServicio: "$encuestasCliente.recomendaria"
        }
    },
    {
        // Ordenar por ID del cliente
        $sort: { idCliente: 1 }
    }
]);
